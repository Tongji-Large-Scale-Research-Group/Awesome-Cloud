# Awesome-Cloud 周刊（第 15 期）：前沿论文-虚拟机vCPU感知调度

## 目录
- Awesome-Cloud 周刊（第 15 期）：前沿论文-Optimizing Task Scheduling in Cloud VMs with Accurate vCPU Abstraction
  - [1. 为什么 - 背景需求](#1-为什么---背景需求)
  - [2. 为什么 - 现有方案不足](#2-为什么---现有方案不足)
  - [3. 做什么 - 创新点](#3-做什么---创新点)
  - [4. 做什么 - 算法设计](#4-做什么---算法设计)
  - [5. 怎么做 - 系统实现](#5-怎么做---系统实现)
  - [6. 怎么样 - 实验评估](#6-怎么样---实验评估)
  - [7. 未来工作](#7-未来工作)

---

### **1. 为什么 - 背景需求**

- **虚拟化普及**：操作系统越来越多地在云虚拟主机 (VMs) 中运行，并负责管理虚拟化资源。然而，作为核心组件的任务调度器，其发展未能跟上虚拟CPU (vCPU) 资源的动态变化。
- **vCPU 的动态性**：与物理CPU不同，vCPU 的性能特征是动态变化的，主要原因包括：
    - **双重调度 (Double Scheduling)**：Hypervisor 调度 vCPU 到物理核心，而虚拟机内的操作系统调度任务到 vCPU。
    - **多租户 (Multi-tenancy)**：vCPU 分时共享物理核心，导致 vCPU 会出现非活动周期和容量波动。
    - **迁移 (Migration)**：VM 或 vCPU 的迁移会改变其性能特征和拓扑结构。
- **vCPU 抽象不准确**：现有的 vCPU 抽象无法准确描述上述动态性，常常错误地将 vCPU 呈现为静态、对称的处理器。这种不匹配会误导调度器，导致性能下降和系统异常。

---
### **2. 为什么 - 现有方案不足**

现有的解决方案主要分为两类，但都有明显的局限性：

- **依赖 Hypervisor 暴露信息**：
    - **方案**：通过半虚拟化 (Paravirtualization) 技术，由 Hypervisor 向虚拟机暴露更准确的 vCPU 信息，如 NUMA 拓扑 (XPV) 或 NUCA 拓扑 (CPS)。
    - **不足**：这类方案**需要修改 Hypervisor**。在多云环境中，由于 Hypervisor 种类繁多或闭源，推广和部署非常困难。同时，暴露更多内部信息会带来额外的安全风险，例如跨 VM 的侧信道攻击。

- **在 Hypervisor 层优化**：
    - **方案**：在 Hypervisor 层改进 vCPU 调度算法，例如缓解锁持有者抢占 (LHP) 问题，或根据虚拟机提供的提示 (hints) 优化调度。
    - **不足**：这些方案同样**需要修改 Hypervisor**。此外，整合不同目标的优化方案本身就非常复杂，特别是当优化目标相互冲突时。

因此，论文的目标是在**不修改 Hypervisor** 的前提下，仅在虚拟机内部优化任务调度。

---
### **3. 做什么 - 创新点**

论文提出了一个名为 **vSched** 的新颖解决方案，其核心创新点在于**无需修改 Hypervisor**，仅在虚拟机内部通过探测来获取准确的 vCPU 抽象，并利用这些信息优化任务调度。

vSched 主要包含两个层面的创新：

1.  **vProbers (vCPU 探测器)**：一套轻量级的微基准测试工具，用于在虚拟机内部探测 vCPU 的动态特性。
    - **VCAP**: 探测动态的 vCPU 容量。
    - **VTOP**: 探测动态的 vCPU 拓扑结构 (如 SMT, Socket, Stacking)。
    - **vACT**: 探测 vCPU 的活动性 (状态和延迟)。

2.  **新的调度优化技术**：基于 vProbers 探测到的准确信息，vSched 引入了三种新的优化技术。
    - **有偏向的 vCPU 选择 (Biased vCPU Selection, BVS)**：将延迟敏感的小任务调度到具有低延迟的 vCPU 上。
    - **虚拟机内收获 (Intra-VM Harvesting, IVH)**：主动将任务从即将进入非活动状态的 vCPU 迁移到空闲的 vCPU 上，以“收获”本应被浪费的 vCPU 时间。
    - **宽松的工作保守性 (Relaxed Work Conservation, RWC)**：有意地“隐藏”有问题的空闲 vCPU（如性能过低的“掉队者”vCPU），避免调度器将任务分配给它们，从而防止性能异常。

---
### **4. 做什么 - 算法设计**

- **vCPU 探测设计 (vProbers)**
    - **VCAP (容量探测)**: 采用协作式、多阶段 (轻量/重量) 采样方法。通过收集`steal time`（vCPU 等待被调度的空闲时间）来计算 vCPU 可用的时间片比例，并结合高优先级探测来估算物理核心的容量，最终计算出 vCPU 的实际容量。使用指数移动平均 (EMA) 来平滑容量数据，避免频繁的任务迁移。
    - **vACT (活动性探测)**: 采用“心跳”机制，通过在每个调度时钟周期记录时间戳来判断 vCPU 的活动/非活动状态。通过分析 `steal time` 的跳变来识别 vCPU 的抢占次数，从而估算出平均的 vCPU 非活动周期，并将其作为“vCPU 延迟”。
    - **VTOP (拓扑探测)**: 通过测量 vCPU 对之间缓存行传输的延迟来确定它们的物理关系（如共享缓存或位于不同插槽）。对于堆叠 (stacking) 的 vCPU，由于它们不能同时运行，缓存传输极少，延迟会非常高。通过多种优化（如并行探测和增量验证）将探测时间缩短至亚秒级。

- **调度优化技术设计**
    - **BVS**: 在为延迟敏感任务选择 vCPU 时，优先考虑高容量、低 vCPU 延迟且长时间处于空闲状态的 vCPU。
    - **IVH**: 周期性地识别在即将非活动的 vCPU 上运行的计算密集型任务，并寻找一个已激活的目标 vCPU。通过中断机制，仅在源和目标 vCPU 都处于活动状态时才执行迁移，以最小化迁移延迟。
    - **RWC**: 识别出容量远低于平均值的“掉队者”(straggler) vCPU 或堆叠 (stacking) 的 vCPU，然后利用 cgroups 机制将它们从调度器的任务放置范围中排除。

---
### **5. 怎么做 - 系统实现**

- **平台**：vSched 在 **Linux kernel v6.1.36** 中实现，并基于 **CFS (Completely Fair Scheduler)** 进行扩展。
- **架构**：
    - **用户态**：vProbers 的大部分逻辑在用户空间实现。
    - **内核态**：通过一个**新的内核模块**将探测结果（如拓扑、容量）暴露给调度器，并动态更新调度域 (schedule domains)。
    - **BPF Hooks**：使用 BPF 挂钩来拦截 CFS 的核心选择路径和时钟中断处理函数，以实现 BVS 和 IVH 的逻辑，避免了创建新的调度类。
    - **cgroups**: 用于实现 RWC，对有问题的 vCPU 进行隔离。
- **代码量**：总代码量为 1612 行，分为内核、BPF 和用户态三部分。
- **特点**：整个实现**无需修改硬件、Hypervisor 或应用程序**，使其成为一个非常实用的解决方案。

---
### **6. 怎么样 - 实验评估**

实验在一台物理服务器上使用 KVM 承载的 Linux 虚拟机进行，评估了 vSched 在多种配置和负载下的性能。

- **实验设置**：
    - **平台**: 使用 HPE ProLiant 服务器和 KVM Hypervisor。
    - **虚拟机**: 设计了两种代表性的虚拟机：资源受限型 (RCVM) 和高性能型 (HPVM)，它们具有不同的 vCPU 数量、拓扑（SMT、堆叠）、容量和延迟特性。
    - **工作负载**: 采用了 34 种不同的基准测试，涵盖延迟敏感型 (Tailbench)、吞吐量密集型 (Parsec, Splash-2x)、Web 服务 (Nginx) 等多种场景。
- **主要结果**：
    - **探测准确性**: vProbers 能够准确地探测 vCPU 的容量和拓扑，且探测时间在亚秒级。
    - **对现有优化的增强**: 仅启用 vProbers 就能显著提升现有调度策略的效果。例如，准确的容量信息使吞吐量提高了 32%；准确的拓扑信息使核心利用率和通信效率显著提高。
    - **BVS 和 IVH 的效果**: BVS 为延迟敏感型负载平均降低了 42% 的 P95 尾延迟。IVH 为吞吐量密集型负载带来了高达 82% 的吞吐量提升。
    - **vSched 整体性能**: 与原生 CFS 相比，vSched 在 RCVM 中平均提升了 69% 的吞吐量，在 HPVM 中平均降低了 2.3 倍的延迟。
    - **适应性与开销**: vSched 能够快速适应 vCPU 的动态变化，并在多租户环境中保持高质量服务。其自身开销很小，在无法带来收益的场景下（如 vCPU 资源稳定），仅引入了平均 0.7% 的性能下降。

---
### **7. 未来工作**

- 将 vSched 的调度启发式思想整合到需要修改 Hypervisor 的半虚拟化方案中，探索协同优化的可能性。
- 将探测技术扩展到 vCPU 之外的其他资源（如内存、I/O），以实现更全面的调度优化。